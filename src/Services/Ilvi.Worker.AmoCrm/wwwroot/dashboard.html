<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İlvi Entegrasyon Paneli</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/cronstrue@latest/dist/cronstrue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.05),
                    0 10px 15px -3px rgba(0, 0, 0, 0.08),
                    0 20px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .nav-glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .status-pulse {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-ring {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -8px rgba(79, 70, 229, 0.3);
        }

        .gradient-text {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.4);
        }

        .table-row {
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
        }

        .badge {
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

<!-- Navigation -->
<nav class="nav-glass px-6 py-4 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-indigo-500/30">
                    İ
                </div>
                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900">İlvi Entegrasyon Merkezi</h1>
                <p class="text-xs text-gray-500 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                    AmoCRM Worker Service
                </p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="loadJobs()" class="icon-btn bg-gray-100 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600" title="Yenile">
                <i class="fa-solid fa-arrows-rotate text-sm"></i>
            </button>
            <a href="/hangfire" target="_blank"
               class="flex items-center gap-2 px-4 py-2.5 bg-gray-900 hover:bg-gray-800 text-white rounded-xl text-sm font-medium transition-all hover:shadow-lg">
                <i class="fa-solid fa-gauge-high"></i>
                <span>Hangfire</span>
                <i class="fa-solid fa-arrow-up-right-from-square text-xs opacity-60"></i>
            </a>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-6 py-8">

    <!-- Stats Cards -->
    <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="stat-card rounded-2xl p-5 backdrop-blur-sm">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Toplam Görev</p>
                    <p id="statTotal" class="text-3xl font-bold text-gray-900 mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-list-check text-indigo-600 text-lg"></i>
                </div>
            </div>
        </div>
        <div class="stat-card rounded-2xl p-5 backdrop-blur-sm">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Başarılı</p>
                    <p id="statSuccess" class="text-3xl font-bold text-green-600 mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-check-circle text-green-600 text-lg"></i>
                </div>
            </div>
        </div>
        <div class="stat-card rounded-2xl p-5 backdrop-blur-sm">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Çalışıyor</p>
                    <p id="statRunning" class="text-3xl font-bold text-blue-600 mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-spinner fa-spin text-blue-600 text-lg"></i>
                </div>
            </div>
        </div>
        <div class="stat-card rounded-2xl p-5 backdrop-blur-sm">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Hatalı</p>
                    <p id="statFailed" class="text-3xl font-bold text-red-600 mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-exclamation-triangle text-red-600 text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-end mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Zamanlanmış Görevler</h2>
            <p class="text-gray-500 mt-1 text-sm">Senkronizasyon görevlerini yönetin ve zamanlama ayarlarını düzenleyin</p>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-400">
            <i class="fa-solid fa-clock"></i>
            <span>Her 30 saniyede otomatik yenilenir</span>
        </div>
    </div>

    <!-- Table Card -->
    <div class="glass-card rounded-2xl overflow-hidden">
        <div class="overflow-x-auto scrollbar-thin">
            <table class="w-full text-left">
                <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-gray-100/50 border-b border-gray-100">
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Görev</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Zamanlama</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Son Çalışma</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Sonraki</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">İşlemler</th>
                </tr>
                </thead>
                <tbody id="jobsTableBody" class="divide-y divide-gray-50">
                <tr>
                    <td colspan="5" class="text-center py-16">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-10 h-10 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
                            <span class="text-gray-400 text-sm">Görevler yükleniyor...</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer Info -->
    <div class="mt-6 flex items-center justify-center gap-6 text-xs text-gray-400">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span>Başarılı</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
            <span>Çalışıyor</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
            <span>Hatalı</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
            <span>Bilinmiyor</span>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api/jobs';

    // SweetAlert2 Custom Theme
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        customClass: {
            popup: 'rounded-xl shadow-xl'
        },
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
        }
    });

    function updateStats(jobs) {
        document.getElementById('statTotal').textContent = jobs.length;
        document.getElementById('statSuccess').textContent = jobs.filter(j => j.lastJobState === 'Succeeded').length;
        document.getElementById('statRunning').textContent = jobs.filter(j => j.lastJobState === 'Processing').length;
        document.getElementById('statFailed').textContent = jobs.filter(j => j.lastJobState === 'Failed').length;
    }

    async function loadJobs() {
        const tbody = document.getElementById('jobsTableBody');

        try {
            const response = await fetch(API_URL);
            let jobs = await response.json();

            tbody.innerHTML = '';
            updateStats(jobs);

            if (jobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-16">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center">
                                    <i class="fa-solid fa-inbox text-2xl text-gray-300"></i>
                                </div>
                                <p class="text-gray-400">Henüz aktif görev bulunmuyor</p>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            // Sorting A-Z
            jobs.sort((a, b) => a.id.localeCompare(b.id));

            jobs.forEach(job => {
                // Cron Description
                let cronDesc = job.cron;
                try {
                    cronDesc = cronstrue.toString(job.cron, { locale: "tr" });
                } catch(e) {}

                // Type Badges
                let typeBadge = '';
                if (job.id.includes('full')) {
                    typeBadge = `<span class="badge inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gradient-to-r from-purple-500 to-purple-600 text-white font-semibold shadow-sm">
                        <i class="fa-solid fa-database text-[8px]"></i> FULL
                    </span>`;
                } else if (job.id.includes('incremental')) {
                    typeBadge = `<span class="badge inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-semibold shadow-sm">
                        <i class="fa-solid fa-bolt text-[8px]"></i> INC
                    </span>`;
                } else {
                    typeBadge = `<span class="badge inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-200 text-gray-600 font-semibold">
                        <i class="fa-solid fa-gear text-[8px]"></i> SYS
                    </span>`;
                }

                // Status Configuration
                let statusConfig = {
                    dot: 'bg-gray-400',
                    ring: 'ring-gray-100',
                    text: 'Bilinmiyor',
                    icon: 'fa-question'
                };

                if (job.lastJobState === 'Succeeded') {
                    statusConfig = { dot: 'bg-green-500', ring: 'ring-green-100', text: 'Başarılı', icon: 'fa-check' };
                } else if (job.lastJobState === 'Failed') {
                    statusConfig = { dot: 'bg-red-500', ring: 'ring-red-100', text: 'Hata', icon: 'fa-xmark' };
                } else if (job.lastJobState === 'Processing') {
                    statusConfig = { dot: 'bg-blue-500 status-pulse', ring: 'ring-blue-100', text: 'Çalışıyor', icon: 'fa-spinner fa-spin' };
                }

                const row = `
                    <tr class="table-row group">
                        <td class="px-6 py-5">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <div class="w-10 h-10 ${statusConfig.ring} ring-4 rounded-xl bg-white flex items-center justify-center shadow-sm">
                                        <span class="w-3 h-3 rounded-full ${statusConfig.dot}"></span>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900">${job.id}</span>
                                        ${typeBadge}
                                    </div>
                                    <span class="text-xs text-gray-400">${statusConfig.text}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex items-center gap-2">
                                <div>
                                    <p class="font-medium text-gray-900 text-sm">${cronDesc}</p>
                                    <code class="text-xs text-gray-400 font-mono bg-gray-100 px-2 py-0.5 rounded mt-1 inline-block">${job.cron}</code>
                                </div>
                                <button onclick="editJob('${job.id}', '${job.cron}')" 
                                    class="icon-btn bg-transparent hover:bg-indigo-100 text-gray-300 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-all ml-2">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fa-regular fa-clock text-gray-400"></i>
                                ${job.lastExecution || '-'}
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-medium border border-indigo-100">
                                <i class="fa-solid fa-calendar-day"></i>
                                ${job.nextExecution}
                            </span>
                        </td>
                        <td class="px-6 py-5 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="triggerJob('${job.id}')" 
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs font-semibold transition-all hover:shadow-lg hover:shadow-indigo-500/30 hover-lift">
                                    <i class="fa-solid fa-play text-[10px]"></i>
                                    Başlat
                                </button>
                                <button onclick="deleteJob('${job.id}')" 
                                    class="icon-btn bg-transparent hover:bg-red-100 text-gray-300 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all"
                                    title="Görevi Sil">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-16">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center">
                                <i class="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i>
                            </div>
                            <p class="text-red-500 font-medium">Veriler yüklenirken hata oluştu</p>
                            <button onclick="loadJobs()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                <i class="fa-solid fa-rotate-right mr-1"></i> Tekrar Dene
                            </button>
                        </div>
                    </td>
                </tr>`;
        }
    }

    async function triggerJob(id) {
        try {
            await fetch(`${API_URL}/trigger/${id}`, { method: 'POST' });
            Toast.fire({
                icon: 'success',
                title: 'Görev başlatıldı!',
                text: `"${id}" tetiklendi`
            });
            setTimeout(loadJobs, 1000);
        } catch (error) {
            Toast.fire({ icon: 'error', title: 'Bir hata oluştu' });
        }
    }

    async function deleteJob(id) {
        Swal.fire({
            title: 'Görevi Sil',
            html: `<p class="text-gray-600"><strong class="text-gray-900">${id}</strong> görevi kalıcı olarak silinecek.</p>`,
            icon: 'warning',
            iconColor: '#ef4444',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: '<i class="fa-solid fa-trash mr-2"></i>Evet, Sil',
            cancelButtonText: 'İptal',
            customClass: {
                popup: 'rounded-2xl',
                confirmButton: 'rounded-xl',
                cancelButton: 'rounded-xl'
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                Toast.fire({ icon: 'success', title: 'Görev silindi!' });
                loadJobs();
            }
        });
    }

    async function editJob(id, currentCron) {
        const { value: newCron } = await Swal.fire({
            title: 'Zamanlamayı Düzenle',
            html: `
                <div class="text-left">
                    <p class="text-sm text-gray-600 mb-4">
                        <strong class="text-gray-900">${id}</strong> için yeni Cron ifadesi girin
                    </p>
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl text-xs text-gray-600 space-y-2">
                        <p class="font-semibold text-gray-700 mb-2"><i class="fa-solid fa-lightbulb text-amber-500 mr-2"></i>Örnek İfadeler:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <div><code class="bg-white px-2 py-1 rounded text-indigo-600">*/15 * * * *</code></div>
                            <div class="text-gray-500">Her 15 dakika</div>
                            <div><code class="bg-white px-2 py-1 rounded text-indigo-600">0 * * * *</code></div>
                            <div class="text-gray-500">Her saat başı</div>
                            <div><code class="bg-white px-2 py-1 rounded text-indigo-600">30 4 * * *</code></div>
                            <div class="text-gray-500">Her gün 04:30</div>
                            <div><code class="bg-white px-2 py-1 rounded text-indigo-600">0 0 * * *</code></div>
                            <div class="text-gray-500">Her gece yarısı</div>
                        </div>
                    </div>
                </div>
            `,
            input: 'text',
            inputValue: currentCron,
            inputPlaceholder: '* * * * *',
            showCancelButton: true,
            confirmButtonText: '<i class="fa-solid fa-save mr-2"></i>Kaydet',
            confirmButtonColor: '#6366f1',
            cancelButtonText: 'İptal',
            customClass: {
                popup: 'rounded-2xl',
                input: 'rounded-xl border-gray-200 font-mono',
                confirmButton: 'rounded-xl',
                cancelButton: 'rounded-xl'
            },
            inputValidator: (value) => {
                if (!value) {
                    return 'Cron ifadesi boş olamaz!';
                }
            }
        });

        if (newCron && newCron !== currentCron) {
            try {
                const response = await fetch(`${API_URL}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, cron: newCron })
                });
                const result = await response.json();
                if (response.ok) {
                    Toast.fire({ icon: 'success', title: 'Zamanlama güncellendi!' });
                    loadJobs();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata!',
                        text: result.message || 'Güncelleme başarısız.',
                        customClass: { popup: 'rounded-2xl' }
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Bağlantı Hatası',
                    text: 'Sunucuya ulaşılamadı.',
                    customClass: { popup: 'rounded-2xl' }
                });
            }
        }
    }

    // Initial load
    loadJobs();

    // Auto refresh every 30 seconds
    setInterval(loadJobs, 30000);
</script>

</body>
</html>